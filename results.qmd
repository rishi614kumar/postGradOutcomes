# Results

In this section, we will explore several questions about the data, separated as parts.

```{r}
library(ggplot2)
library(dplyr)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidytext))
library(ggrepel)
library(tidyr)
library(parcoords)
library(htmltools)

options(ggplot2.discrete.fill.warning = FALSE)
```

```{r}
source("scripts/pseoe_preprocessing.R")
pseoe <- read_csv("data/pseoe_all.csv", show_col_types = FALSE)
degree_mapping <- read.csv("data/label_degree_level.csv")
cipcode_mapping <- read.csv("data/label_cipcode.csv")
institution_mapping <- read.csv("data/label_institution.csv")


pseoe <- preprocess_pseoe(
  pseoe = pseoe,
  degree_mapping = degree_mapping,
  cipcode_mapping = cipcode_mapping,
  institution_mapping = institution_mapping
)
#cat("Rows:", nrow(pseoe), "\nColumns:", ncol(pseoe), "\n")
```

## What are the top-earning fields of study within each degree type and across time?

```{r, fig.width=10, fig.height=12}

top_n <-5

plot_df <-pseoe |>
  group_by(degree_level, degree_label, cipcode_label) |>
  summarize(
    median_y1_earnings = mean(y1_p50_earnings, na.rm = TRUE),
    median_y5_earnings =mean(y5_p50_earnings, na.rm = TRUE),
    median_y10_earnings= mean(y10_p50_earnings, na.rm = TRUE),
    .groups="drop"
  ) |>
  filter(
    !is.na(median_y1_earnings) | 
    !is.na(median_y5_earnings)| 
    !is.na(median_y10_earnings)
  ) |>
  arrange(degree_level, desc(median_y10_earnings)) |>
  group_by(degree_label) |>
  slice_head(n =top_n) |>
  mutate(
    cipcode_label=reorder_within(
      cipcode_label,-median_y10_earnings, degree_label
    )
  ) |>
  pivot_longer(
    cols = starts_with("median"), 
    names_to="year", values_to ="median_earnings"
  ) |>
  mutate(
    year=factor(
      year, levels=c(
        "median_y1_earnings","median_y5_earnings", "median_y10_earnings"
      ),
      labels=c("Year 1", "Year 5", "Year 10")
    ),
    degree_label =factor(
      degree_label, levels=unique(degree_label[order(degree_level)])
    )
  )

suppressWarnings(
  ggplot(plot_df, aes(x= cipcode_label, y=median_earnings, fill =year)) +
    geom_bar(stat ="identity", position="dodge",na.rm = TRUE) +
    facet_wrap(~degree_label, scales="free_x", nrow =2, drop =TRUE) + 
    scale_x_reordered() + 
    scale_y_continuous(labels = scales::label_number(big.mark = ",", decimal.mark = ".")) +
    theme_minimal(base_size =14) + 
    labs(
      title =paste("Top", top_n, "Avg. Median Earnings by Field of Study and Degree Type") ,
      x= "Field of Study",
      y="Avg. Median Earnings (2021 US Dollars)",
      fill ="Earnings Year"
    ) +
    theme(
      axis.text.x = element_text(angle =55, hjust =1, size=10),
      axis.title.y=element_text(margin = margin(r = 10)),
      strip.text = element_text(size = 12, face = "bold", margin = margin(b=5)),
      panel.grid.major.x= element_blank(),
      plot.margin = margin(t = 20, r= 10, b = 20, l = 20),
      legend.position="top", legend.direction="horizontal"
    )
)
```

The plot displays the top 5 earning fields of study for each degree type. While the general intuition that higher degrees yield higher income holds true, there are notable exceptions.

Certificates, for instance, often result in lower income compared to associate or bachelor's degrees for the upper echelon earnings. This could be because many pursuing certificates are transitioning into new fields, starting at entry-level positions in their new career paths.

Certain fields stand out for disproportionately high earnings at advanced degree levels. For example, graduates with Health Profession Master’s degrees often earn more in Year 1 than most Doctoral - Research graduates make even 10 years post-graduation. This might reflect the immediate applicability and demand for healthcare expertise, like possibly nursing.

Furthermore, fields related to science and technology consistently dominate top-earning outcomes across all degree levels. This likely reflects the consistent demand and high value placed on specialized technical and analytical skills in the labor market. However, healthcare professionals appear to significantly increase their earning potential with advanced degrees, while engineering fields tend to show steady earning growth across all degree levels.

## How do earnings compare across states and time?

```{r, fig.width=10, fig.height=12}

plot_df <- pseoe |>
  filter(!institution_state %in% c("Others", "US")) |>
  group_by(institution_state) |>
  summarize(
    median_y1_earnings = mean(y1_p50_earnings, na.rm = TRUE),
    median_y5_earnings = mean(y5_p50_earnings, na.rm = TRUE),
    median_y10_earnings = mean(y10_p50_earnings, na.rm = TRUE),
    .groups = "drop"
  ) |>
  filter(
    !is.na(median_y1_earnings) | 
    !is.na(median_y5_earnings) | 
    !is.na(median_y10_earnings)
  ) |>
  mutate(
    sort_value = ifelse(is.na(median_y10_earnings), median_y5_earnings, median_y10_earnings),
    institution_state = reorder(institution_state, sort_value)
  ) |>
  pivot_longer(
    cols = starts_with("median"),
    names_to = "year",
    values_to = "median_earnings"
  ) |>
  mutate(
    year = factor(
      year, levels = c(
        "median_y1_earnings", "median_y5_earnings", "median_y10_earnings"
      ),
      labels = c("Year 1", "Year 5", "Year 10")
    )
  )

suppressWarnings(
  ggplot(plot_df, aes(x = median_earnings, y = institution_state, color = year)) +
    geom_point(size = 3, position = position_dodge(width = 0.5)) +
    scale_x_continuous(labels = scales::label_number(big.mark = ",", decimal.mark = "."))+
    theme_minimal(base_size = 14) +
    labs(
      title = "Avg. Median Earnings by State",
      x = "Avg. Median Earnings (2021 US Dollars)",
      y = "State",
      color = "Earnings Year"
    ) +
    theme(
      axis.text.y = element_text(size = 10),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      plot.margin = margin(t = 20, r = 10, b = 20, l = 20),
      legend.position = "top", legend.direction = "horizontal"
    )
)

```

This plot shows income outcomes by state, validating the intuition that more experience generally leads to higher earnings across all states.

However, income levels vary significantly between states. For instance, Rhode Island’s average median income one year after graduation rivals South Dakota’s ten-year figure, highlighting disparities likely driven by the dominant industries in each state. States with higher-paying industries, like finance or technology, tend to have higher earnings, while rural or agriculture-focused states remain lower.

Notably, a large population state like New York shows a relatively low average median income in Year 1 but a significantly higher value by Year 10. This may reflect the variability and range of salaries in the state, driven by its diverse opportunities and the large population accessing them.

## Is there a correlation between Year 1 income outcomes and employment counts by degree level?

```{r, fig.width=10, fig.height=12}

plot_df <- pseoe |>
  group_by(degree_level, degree_label) |>
  summarize(
    avg_median_y1_earnings = mean(y1_p50_earnings, na.rm = TRUE),
    total_employment = sum(y1_grads_earn, na.rm = TRUE),
    .groups = "drop"
  ) |>
  filter(
    !is.na(avg_median_y1_earnings),
    total_employment > 0
  ) |>
  arrange(degree_level)

suppressWarnings(
  ggplot(plot_df, aes(y = total_employment, x = avg_median_y1_earnings)) +
    geom_point(size = 4, color = "red") +
    geom_label_repel(aes(label = degree_label), 
                     size = 4, 
                     max.overlaps = Inf, 
                     box.padding = 0.5, 
                     point.padding = 0.5, 
                     segment.color = "grey50") +
    theme_minimal(base_size = 14) +
    scale_x_continuous(labels = scales::label_number(big.mark = ",", decimal.mark = ".")) +
    scale_y_continuous(labels = scales::label_number(big.mark = ",", decimal.mark = ".")) +
    labs(
      title = "Employment Counts vs. Avg. Median Earnings by Degree Type (Year 1)",
      y = "Total Year 1 Employment Count",
      x = "Avg. Median Earnings (2021 US Dollars)"
    ) +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title.x = element_text(size = 14, margin = margin(t = 10)),
      axis.title.y = element_text(size = 14, margin = margin(r = 10)),
      plot.margin = margin(t = 20, r = 10, b = 20, l = 20)
    )
)

```

This plot shows Year 1 average median earnings against total Year 1 employment counts. While one might assume that higher degree levels - and their associated higher income - would attract more graduates, the data shows no clear correlation. High-paying degrees like Doctoral - Prof. and Doctoral - Research have relatively low employment counts, while degrees like Baccalaureate and Associates have much higher counts despite lower incomes.

Certificate programs (\<1 year and 1-2 years) cluster at the low end for both earnings and employment, reinforcing their role as niche credentials, potentially for those who are looking to switch careers as stated earlier.

Masters degrees seem to balance moderate incomes and employment by occupying the middle ground. Overall, this plot clearly suggests that factors beyond immediate income, such as accessibility, cost, and career pathways, may heavily influence degree level choices.

## How does the total number of graduates compare to employed graduates by degree level, one year from graduation?

```{r, fig.width=10, fig.height=10}

plot_df <- pseoe |>
  group_by(degree_label, degree_level) |>
  summarize(
    total_graduates = sum(y10_ipeds_count, na.rm = TRUE),
    total_employment = sum(y10_grads_earn, na.rm = TRUE),
    .groups = "drop"
  ) |>
  filter(
    total_graduates > 0,
    total_employment >= 0
  ) |>
  arrange(degree_level) |>
  mutate(
    degree_label = factor(degree_label, levels = unique(degree_label[order(degree_level)]))
  )

plot_df_long <- plot_df |>
  pivot_longer(
    cols = c(total_employment, total_graduates),
    names_to = "status",
    values_to = "count"
  ) |>
  mutate(
    status = factor(status, levels = c("total_employment", "total_graduates"),
                    labels = c("Employed", "Graduates"))
  )

suppressWarnings(
  ggplot(plot_df_long, aes(x = count, y = degree_label, color = status)) +
    geom_segment(data = plot_df, aes(x = total_employment, xend = total_graduates, 
                                     y = degree_label, yend = degree_label), 
                 inherit.aes = FALSE, color = "grey50", size = 1) +
    geom_point(size = 4) +
    scale_color_manual(values = c("red", "blue")) +
    theme_minimal(base_size = 14) +
    scale_x_continuous(labels = scales::label_number(big.mark = ",", decimal.mark = ".")) +
    labs(
      title = "Graduate vs. Employment Counts by Degree Level (Year 1)",
      x = "Count of Students",
      y = "Degree Level",
      color = "Employment Status"
    ) +
    theme(
      axis.text.x = element_text(size = 12),
      axis.text.y = element_text(size = 12),
      axis.title.x = element_text(size = 14, margin = margin(t = 10)),
      axis.title.y = element_text(size = 14, margin = margin(r = 10)),
      plot.margin = margin(t = 20, r = 10, b = 20, l = 20),
      legend.position = "top", legend.direction = "horizontal"
    )
)

```

This plot shows the difference between total graduates and those employed one year after graduation. Niche degrees, such as certificates and doctoral degrees, show higher employment rates, with relatively small gaps between graduates and employed individuals. In contrast, more general degrees like Associates, Baccalaureate, and Masters show noticeable gaps, indicating that a significant portion of graduates remain unemployed.

This discrepancy could be due to the broader applicability and generality of these degrees, which may lead to greater variability in employment outcomes. Additionally, the larger graduate populations for these degrees might create more competition in the job market, further contributing to the gaps. Also, the relatively small graduate numbers in niche fields may align better with job market demand, which would result in the higher observed employment rates.

## How do employment outcomes compare across the most popular fields?

```{r, fig.width=10, fig.height=12}


top_n <- 20
plot_df <- pseoe |>
  group_by(cipcode_label) |>
  summarize(
    total_graduates = sum(y1_ipeds_count, na.rm = TRUE),
    employment_rate = sum(y1_grads_earn, na.rm = TRUE) / total_graduates,
    avg_median_y1_income = mean(y1_p50_earnings, na.rm = TRUE),
    avg_median_y5_income = mean(y5_p50_earnings, na.rm = TRUE),
    avg_median_y10_income = mean(y10_p50_earnings, na.rm = TRUE),
    .groups = "drop"
  ) |>
  filter(total_graduates > 0) |>
  arrange(desc(total_graduates)) |>
  slice_head(n = top_n)

plot_df_normalized <- plot_df |>
  mutate(
    employment_rate = scales::rescale(employment_rate),
    avg_median_y1_income = scales::rescale(avg_median_y1_income),
    avg_median_y5_income = scales::rescale(avg_median_y5_income),
    avg_median_y10_income = scales::rescale(avg_median_y10_income)
  )

title_text<-sprintf("Employability and Income Analysis for Top %d Historically Popular Fields of Study (Normalized)", top_n)
title <- tags$h3(title_text)

# https://edav.info/multidimensional_continuous.html#interactive-parallel-coordinate-plot
parcoords_plot <- parcoords(
  data = plot_df_normalized,
  rownames = FALSE,
  brushMode = "1D-axes",
  color = list(colorBy = "cipcode_label", colorScale = "scaleOrdinal", colorScheme = "schemeCategory10"),
  alpha = 0.5,
  withD3 = TRUE,
  #width = 1000,
  #height = 600
)

#scrollable_fix <- htmltools::div(
#  style = "overflow-y: auto; height: 600px; border: 1px solid #ccc; padding: 10px;",
#  parcoords_plot
#)

htmltools::browsable(tagList(title, parcoords_plot))
#htmltools::browsable(tagList(title, scrollable_fix))

```

This plot provides an analysis of employment outcomes, including employment rates and income trajectories, for the most popular fields of study (by graduate volume).

Fields like Homeland Security, Business Management, and Registered Nursing show high employment rates, which make them attractive for those seeking immediate job security. However, their normalized median incomes decline over time relative to other fields, suggesting potential income stagnation for graduates in these areas.

Fields like Biological and Biomedical Engineering start with lower relative employment rates and initial incomes but demonstrate steady and appreciable growth in earnings over time. This indicates strong potential for career growth.

Also, while its employment rate remains middling compared to the other majors, Engineering achieves the highest normalized income growth, making it an excellent choice for those prioritizing long-term earning potential over initial job placement.

Overall, these trends highlight how different fields of study align with various career priorities - whether it's immediate employment or sustained income growth over time. A prospective student can weigh their personal goals to select a major by these metrics.



## Growth potential: relation between y1 and y10 earnings

We already saw that different types of degrees clearly result in different earnings outcomes, for one, five or ten years after graduation. Related to this, we could also look at the growth potential for different types of degrees. Here we quantify the growth potential as the relation between the earnings one year and ten years after graduation.

```{r,fig.width=9, fig.height=9}
pseoe_y1andy10 <- pseoe |>
                  filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
                  filter(status_y10_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) 

ggplot(pseoe_y1andy10, aes(x = y1_p50_earnings, y = y10_p50_earnings)) +
  geom_point(alpha=0.2) +
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
  facet_wrap(~degree_label) +
  labs(
    x = "Median earnings one year after graduation",
    y = "Median earnings ten years after graduation",
    title = "Median earnings one versus ten years after graduation, per degree type",
  ) +
  theme_grey(13)
```
This plot shows scatterplots for median earnings one year versus ten years after graduation, one for each type of degree. In these plots, each dot represents one cohort. The red dashed line corresponds to "zero growth potential", i.e. the median earnings one and ten years after graduation is the same. We see that for all degree types, almost all cohorts have higher median earnings ten years after graduation. However, the range of magnitudes of this difference seems to depend strongly on the type of degree. The strongest growth potential seems to occur for cohorts in a professional doctoral program, where the median earnings 10 years after graduation can grow up to almost \$400,000 from around \$60,000 one year after graduation. Furthermore, bachelor's programs also allow for significant growth potential, where earnings ten years after graduation often seem to be \$100,000 higher than one year after graduation.

Research doctoral and Master's programs seem to have smaller increases in earnings one to ten years after graduation than bachelor's programs, but graduates from these programs do however start with higher earnings one year after graduation. The different types of certificates and associates degrees also seem to have some growth potential, with associates degrees showing increases in earnings of up to around \$80,000.


## Is a Master's worth it?

Should I get a Master's? This is a difficult question faced by many students who obtained their undergraduate degree. Here we try to provide insights into this question by looking at the difference in earnings for bachelor's versus master's graduates in the same field of study.

```{r, fig.width=10, fig.height=12}
pseoe_popular_cipcodes_Bach_Masters <- pseoe |>
  filter(cipcode != "00") |>
  filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  group_by(cipcode) |>
  filter(all(c("05", "07") %in% degree_level)) |>
  ungroup() |>
  filter(degree_level == "05" | degree_level == "07") |>
  group_by(cipcode) |>
  summarize(total_grads = sum(y1_ipeds_count, na.rm = TRUE)) |>
  arrange(desc(total_grads)) |>
  slice_head(n = 20)

top_cipcodes <- unique(pseoe_popular_cipcodes_Bach_Masters$cipcode)

pseoe_earnings_top_cipcode_Bach_Masters <- pseoe |>
  filter(cipcode %in% top_cipcodes) |>
  filter(degree_level == "05" | degree_level == "07") |>
  group_by(cipcode_label, degree_label) |>
  summarize(avg_y1_p50_earnings = mean(y1_p50_earnings, na.rm = TRUE),
            .groups = "drop") |>
  mutate(cipcode_label = fct_reorder(cipcode_label, avg_y1_p50_earnings, .fun = mean))


ggplot(pseoe_earnings_top_cipcode_Bach_Masters, aes(x=avg_y1_p50_earnings, y=cipcode_label, color=degree_label)) +
  geom_point(size = 3) +
  labs(
    x = "Average median earnings one year after graduation",
    y = "Field of study",
    title = "Average median earnings for bachelor's versus master's graduates",
    color = "Type of degree"
  ) +
  theme(
      axis.text.y = element_text(size = 10),
      axis.title.x = element_text(margin = margin(t = 10)),
      axis.title.y = element_text(margin = margin(r = 10)),
      plot.margin = margin(t = 20, r = 10, b = 20, l = 20),
      legend.position = "top", legend.direction = "horizontal"
    )


```

```{r}
pseoe_popular_cipcodes_Bach_Masters <- pseoe |>
  filter(cipcode != "00") |>
  filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  group_by(cipcode) |>
  filter(all(c("05", "07") %in% degree_level)) |>
  ungroup() |>
  filter(degree_level == "05" | degree_level == "07") |>
  group_by(cipcode) |>
  summarize(total_grads = sum(y1_ipeds_count, na.rm = TRUE)) |>
  arrange(desc(total_grads)) |>
  slice_head(n = 20)

top_cipcodes <- unique(pseoe_popular_cipcodes_Bach_Masters$cipcode)

pseoe_earnings_top_cipcode_Bach_Masters <- pseoe |>
  filter(cipcode %in% top_cipcodes) |>
  filter(degree_level == "05" | degree_level == "07") |>
  group_by(cipcode_label, degree_label) |>
  summarize(avg_y1_p50_earnings = mean(y1_p50_earnings, na.rm = TRUE),
            avg_y1_p25_earnings = mean(y1_p25_earnings, na.rm = TRUE),
            avg_y1_p75_earnings = mean(y1_p75_earnings, na.rm = TRUE), 
            .groups = "drop") |>
  mutate(cipcode_label = fct_reorder(cipcode_label, avg_y1_p50_earnings, .fun = mean)) |>
  pivot_longer(
    cols = c(avg_y1_p50_earnings, avg_y1_p25_earnings, avg_y1_p75_earnings),
    names_to = "percentile",
    values_to = "earnings"
  )


ggplot(pseoe_earnings_top_cipcode_Bach_Masters, aes(x=earnings, y=cipcode_label, color=degree_label)) +
  geom_point()



```
```{r}
pseoe_popular_cipcodes_Bach_Masters <- pseoe |>
  filter(cipcode != "00") |>
  filter(status_y5_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  group_by(cipcode) |>
  filter(all(c("05", "07") %in% degree_level)) |>
  ungroup() |>
  filter(degree_level == "05" | degree_level == "07") |>
  group_by(cipcode) |>
  summarize(total_grads = sum(y5_ipeds_count, na.rm = TRUE)) |>
  arrange(desc(total_grads)) |>
  slice_head(n = 20)

top_cipcodes <- unique(pseoe_popular_cipcodes_Bach_Masters$cipcode)


pseoe_earnings_top_cipcode_Bach_Masters <- pseoe |>
  filter(cipcode %in% top_cipcodes) |>
  filter(degree_level == "05" | degree_level == "07") |>
  group_by(cipcode_label, degree_label) |>
  summarize(avg_y5_p50_earnings = mean(y5_p50_earnings, na.rm = TRUE), .groups = "drop") |>
  mutate(cipcode_label = fct_reorder(cipcode_label, avg_y5_p50_earnings, .fun = mean))

#  left_join(cipcode_mapping |> select(cipcode, label), by = "cipcode") |>
#  rename(cipcode_label = label) |>
#  left_join(degree_mapping |> select(degree_level, label), by = "degree_level") |>
#  rename(degree_label = label)

ggplot(pseoe_earnings_top_cipcode_Bach_Masters, aes(x=avg_y5_p50_earnings, y=cipcode_label, color=degree_label)) +
  geom_point()

```

## How important is the institution where you earned your degree?

```{r}
library(ggplot2)
library(ggridges)

# Identify top 20 degree-CIP code combinations by total graduates
pseoe_popular_degrees <- pseoe |>
  filter(cipcode != "00") |>
  filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  filter(status_y1_ipeds_count %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  group_by(degree_label, cipcode_label) |>
  summarize(total_grads = sum(y1_ipeds_count, na.rm = TRUE), .groups = "drop") |>
  arrange(desc(total_grads)) |>
  slice_head(n = 20) |>
  mutate(cipcode_degree_label = paste(cipcode_label, degree_label, sep = " - "))

# Calculate median earnings for ordering
pseoe_ridgeline_data <- pseoe |>
  filter(cipcode != "00") |>
  filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  filter(status_y1_ipeds_count %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  mutate(cipcode_degree_label = paste(cipcode_label, degree_label, sep = " - ")) |>
  filter(cipcode_degree_label %in% pseoe_popular_degrees$cipcode_degree_label) |>
  group_by(cipcode_degree_label, institution) |>
  summarize(avg_y1_p50_earnings = mean(y1_p50_earnings, na.rm = TRUE), .groups = "drop") |>
  group_by(cipcode_degree_label) |>
  mutate(median_earnings = median(avg_y1_p50_earnings, na.rm = TRUE)) |>
  ungroup() |>
  arrange(desc(median_earnings)) |>
  mutate(cipcode_degree_label = factor(cipcode_degree_label, levels = rev(unique(cipcode_degree_label))))


# Ridgeline plot
ggplot(pseoe_ridgeline_data, aes(x = avg_y1_p50_earnings, y = cipcode_degree_label)) +
  geom_density_ridges(alpha = 0.8, scale = 1.5, fill = "cornflowerblue") +
  labs(
    x = "Average Year 1 P50 Earnings",
    y = "Degree field and level",
    title = "Ridgeline Plot of Average Year 1 P50 Earnings",
  ) +
  theme_minimal()

```
```{r}
# Calculate median earnings for ordering
pseoe_ridgeline_data <- pseoe |>
  filter(cipcode != "00") |>
  filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  filter(status_y1_ipeds_count %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  mutate(cipcode_degree_label = paste(cipcode_label, degree_label, sep = " - ")) |>
  filter(cipcode_degree_label %in% pseoe_popular_degrees$cipcode_degree_label) |>
  group_by(cipcode_degree_label, institution) |>
  summarize(avg_y1_p75_earnings = mean(y1_p75_earnings, na.rm = TRUE), .groups = "drop") |>
  group_by(cipcode_degree_label) |>
  mutate(median_earnings = median(avg_y1_p75_earnings, na.rm = TRUE)) |>
  ungroup() |>
  arrange(desc(median_earnings)) |>
  mutate(cipcode_degree_label = factor(cipcode_degree_label, levels = rev(unique(cipcode_degree_label))))


# Ridgeline plot
ggplot(pseoe_ridgeline_data, aes(x = avg_y1_p75_earnings, y = cipcode_degree_label)) +
  geom_density_ridges(alpha = 0.8, scale = 1.5, fill = "cornflowerblue") +
  labs(
    x = "Average Year 1 P50 Earnings",
    y = "Degree field and level",
    title = "Ridgeline Plot of Average Year 1 P75 Earnings",
    fill = "Median Earnings"
  ) +
  theme_minimal()


```
## How have career prospects changed?


```{r}
idcols_inst <- c(
  "agg_level_pseo", "inst_level", "institution", "degree_level",
  "cip_level", "cipcode" 
)

pseoe_01and16 <- pseoe |> 
                      filter(grad_cohort == "2001" | grad_cohort == "2016") |>
                      filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
                      filter(!institution_state %in% c("Others", "US")) |>
                      group_by(across(all_of(idcols_inst))) |>
                      filter(all(c("2001", "2016") %in% grad_cohort))

pseoe_cipcode_change01to16 <- pseoe_01and16|>
                              group_by(cipcode_label, degree_label, grad_cohort) |>
                              summarise(mean_med_earning = mean(y1_p50_earnings, na.rm = TRUE), .groups = "drop") |>
                              ungroup() |>
                              pivot_wider(names_from = grad_cohort, values_from = mean_med_earning, 
                                          names_prefix ="earnings_") |> 
                              mutate(change_med_earning = earnings_2016 - earnings_2001)

pseoe_cipcode_change01to16 <- pseoe_cipcode_change01to16 |>
  arrange(change_med_earning) |>
  select(cipcode_label, degree_label, change_med_earning) |>
  mutate(cipcode_degree_label = paste(cipcode_label, degree_label, sep = " - "))

```


```{r}
ggplot(tail(pseoe_cipcode_change01to16, 15), aes(y = factor(cipcode_degree_label,
                                                                   levels = cipcode_degree_label[order(change_med_earning)]),
                                                        x = change_med_earning)) +
  geom_col() +
  ylab("Degree field and level") +
  xlab("Change in average median Earning from 2001 to 2016")
```


```{r}
ggplot(pseoe_cipcode_change01to16[1:15, ], aes(y = factor(cipcode_degree_label,
                                                                   levels = cipcode_degree_label[order(change_med_earning)]),
                                                        x = change_med_earning)) +
  geom_col() +
  ylab("Degree field and level") +
  xlab("Change in average median Earning from 2001 to 2016")
```

```{r}
pseoe_01and16 |> filter(cipcode_label == "Pharmacy, Pharmaceutical...", degree_label == "Baccalaureate")
```

```{r}
pseoe_typedegree_change01to16 <- pseoe_01and16 |>
                              group_by(degree_label, grad_cohort) |>
                              summarise(mean_med_earning = mean(y1_p50_earnings, na.rm = TRUE), .groups = "drop") |>
                              ungroup() |>
                              pivot_wider(names_from = grad_cohort, values_from = mean_med_earning, 
                                          names_prefix ="earnings_") |> # Reshape data
                              mutate(change_med_earning = earnings_2016 - earnings_2001) # Compute change

pseoe_typedegree_change01to16 <- pseoe_typedegree_change01to16 |>
  arrange(change_med_earning) |>
  select(degree_label, change_med_earning)
```

```{r}
ggplot(pseoe_typedegree_change01to16, aes(y = factor(degree_label,
                                                                   levels = degree_label[order(change_med_earning)]),
                                                        x = change_med_earning)) +
  geom_col() +
  ylab("Degree type") +
  xlab("Change in Year 1 Median Earning") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


## How does employment rate relate to earnings?

```{r}
pseoe_per_degree <- pseoe |>
                    filter(status_y1_earnings %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
                    filter(status_y1_ipeds_count %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
                    group_by(cipcode_label, degree_label) |>
                    summarize(avg_y1_p50_earnings = mean(y1_p50_earnings, na.rm = TRUE),
                              employment_rate = sum(y1_grads_earn)/sum(y1_ipeds_count), .groups = "drop") |>
                    filter(employment_rate < 1)

ggplot(pseoe_per_degree, aes(x=employment_rate, y=avg_y1_p50_earnings)) +
  geom_point(alpha=0.5) +
  facet_wrap(~degree_label)

```

```{r}
pseoe |>
  filter(status_y1_grads_earn %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  filter(status_y1_ipeds_count %in% c(1, 2, 4, 6, 7, 9, 10, 12)) |>
  filter(institution_state != "Others" & institution_state != "US") |>
  filter(grad_cohort != "0000") |>
  filter(cipcode != "00") |>
  group_by(cipcode_label, degree_label) |>
  summarize(employment_rate = sum(y1_grads_earn)/sum(y1_ipeds_count), .groups = "drop") |>
  filter(employment_rate > 1)
```


## How did graduation cohort sizes change over time?


```{r}
grads_per_cohort <- pseoe |>
        filter(grad_cohort != "0000") |>
        group_by(grad_cohort) |>
        summarize(avg_cohort_size = mean(y1_ipeds_count, na.rm = TRUE)) 
ggplot(grads_per_cohort, aes(x=grad_cohort, y=avg_cohort_size)) +
  geom_col()

```
